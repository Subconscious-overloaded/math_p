import numpy as np 
import matplotlib.pyplot as plt
%matplotlib inline
from math import factorial
from scipy.signal import savgol_filter

i = ['0\n', '0.61\n', '0.458\n', '-0.61\n', '-2.441\n', '-2.747\n', '-3.357\n', '-2.289\n', '-2.136\n', '-1.831\n', '-0.305\n', '-1.221\n', '3.51\n', '1.221\n', '0.305\n', '-0.153\n', '1.984\n', '0.61\n', '-0.305\n', '-0.458\n', '-0.305\n', '-1.984\n', '0.458\n', '-4.73\n', '2.441\n', '6.256\n', '14.496\n', '12.055\n', '18.159\n', '20.447\n', '25.33\n', '27.772\n', '29.603\n', '32.502\n', '35.401\n', '37.233\n', '42.573\n', '48.982\n', '49.135\n', '54.17\n', '53.713\n', '57.985\n', '60.579\n', '65.157\n', '67.751\n', '72.939\n', '71.871\n', '74.313\n', '81.179\n', '81.637\n', '87.13\n', '89.724\n', '92.013\n', '93.081\n', '100.406\n', '100.558\n', '103.153\n', '106.967\n', '108.493\n', '115.36\n', '115.36\n', '118.107\n', '121.159\n', '123.447\n', '126.957\n', '131.687\n', '133.366\n', '136.723\n', '140.538\n', '144.353\n', '149.541\n', '147.252\n', '151.83\n', '154.271\n', '156.255\n', '160.68\n', '167.852\n', '164.8\n', '170.751\n', '171.514\n', '175.329\n', '178.991\n', '183.721\n', '184.942\n', '189.52\n', '191.198\n', '193.335\n', '196.234\n', '200.659\n', '201.575\n', '207.831\n', '208.747\n', '213.935\n', '215.613\n', '216.987\n', '218.207\n', '223.701\n', '227.668\n', '228.584\n', '228.126\n', '234.84\n', '238.35\n', '239.875\n', '241.401\n', '247.658\n', '250.404\n', '254.372\n', '254.067\n', '259.255\n', '260.628\n', '263.833\n', '265.664\n', '266.579\n', '272.683\n', '273.141\n', '275.887\n', '276.345\n', '281.838\n', '284.28\n', '284.127\n', '288.705\n', '290.689\n', '293.893\n', '298.013\n', '299.081\n', '300.76\n', '307.321\n', '310.678\n', '313.273\n', '314.188\n', '317.545\n', '319.834\n', '325.632\n', '324.564\n', '329.6\n', '328.074\n', '332.347\n', '333.567\n', '339.671\n', '343.944\n', '341.655\n', '346.69\n', '350.505\n', '350.353\n', '352.184\n', '355.236\n', '359.813\n', '359.966\n', '363.018\n', '364.544\n', '370.495\n', '373.852\n', '377.972\n', '376.446\n', '381.176\n', '383.16\n', '385.601\n', '389.874\n', '388.958\n', '393.841\n', '395.672\n', '400.098\n', '398.572\n', '402.692\n', '404.37\n', '409.253\n', '412.763\n', '415.815\n', '417.341\n', '420.545\n', '421.613\n', '424.97\n', '425.733\n', '429.701\n', '431.532\n', '432.447\n', '439.314\n', '439.772\n', '444.197\n', '444.655\n', '447.401\n', '448.012\n', '450.606\n', '452.437\n', '454.878\n', '456.557\n', '459.761\n', '462.508\n', '468.154\n', '468.001\n', '473.647\n', '474.105\n', '475.021\n', '477.767\n', '478.225\n', '483.261\n', '484.634\n', '489.975\n', '491.501\n', '492.874\n', '495.468\n', '497.604\n', '502.03\n', '504.013\n', '504.776\n', '507.218\n', '511.643\n', '514.389\n', '515\n', '516.526\n', '520.493\n', '521.409\n', '524.613\n', '524.613\n', '528.428\n', '533.158\n', '532.701\n', '535.447\n', '535.6\n', '541.093\n', '544.298\n', '546.434\n', '546.434\n', '550.554\n', '554.369\n', '553.453\n', '559.557\n', '562.151\n', '562.914\n', '562.151\n', '569.018\n', '567.797\n', '569.933\n', '573.748\n', '575.732\n', '577.258\n', '580.615\n', '581.835\n', '584.124\n', '585.955\n', '588.092\n', '590.228\n', '591.754\n', '596.027\n', '597.858\n', '599.383\n', '601.978\n', '604.572\n', '602.741\n', '608.997\n', '609.149\n', '616.474\n', '618\n', '619.221\n', '620.289\n', '622.272\n', '625.629\n', '627.308\n', '629.902\n', '632.191\n', '635.701\n', '636.769\n', '640.126\n', '641.346\n', '639.668\n', '644.093\n', '645.161\n', '647.908\n', '648.976\n', '651.418\n', '654.775\n', '655.995\n', '657.827\n', '662.252\n', '663.778\n', '664.846\n', '666.524\n', '668.355\n', '669.881\n', '672.475\n', '672.018\n', '675.985\n', '681.173\n', '680.715\n', '683.157\n', '684.53\n', '688.955\n', '689.413\n', '691.397\n', '692.007\n', '693.686\n', '695.669\n', '696.432\n', '700.4\n', '703.757\n', '704.062\n', '705.435\n', '708.487\n', '710.471\n', '711.539\n', '712.76\n', '718.253\n', '718.558\n', '722.221\n', '720.695\n', '726.188\n', '722.373\n', '728.629\n', '733.97\n', '734.275\n', '734.886\n', '735.496\n', '740.532\n', '740.684\n', '741.447\n', '747.246\n', '748.619\n', '749.535\n', '748.161\n', '756.706\n', '752.586\n', '753.197\n', '755.638\n', '761.132\n', '759.301\n', '762.658\n', '767.235\n', '767.083\n', '769.829\n', '773.034\n', '778.527\n', '775.018\n', '774.102\n', '777.001\n', '780.053\n', '779.748\n', '785.089\n', '783.715\n', '786.157\n', '786.004\n', '788.293\n', '791.04\n', '791.803\n', '794.549\n', '797.906\n', '797.906\n', '799.585\n', '802.789\n', '804.315\n', '802.637\n', '805.841\n', '805.841\n', '808.283\n', '808.893\n', '810.114\n', '809.198\n', '810.877\n', '813.318\n', '812.098\n', '814.692\n', '818.964\n', '816.065\n', '818.354\n', '821.101\n', '821.863\n', '823.237\n', '824\n', '824.457\n', '826.441\n', '825.373\n', '828.12\n', '826.441\n', '825.526\n', '828.883\n', '830.256\n', '832.087\n', '833.766\n', '832.087\n', '833.766\n', '833.613\n', '835.444\n', '835.597\n', '836.665\n', '836.512\n', '837.275\n', '835.902\n', '840.022\n', '840.48\n', '839.259\n', '844.6\n', '840.938\n', '840.48\n', '841.09\n', '844.142\n', '845.973\n', '849.635\n', '843.684\n', '849.025\n', '849.33\n', '850.398\n', '845.515\n', '846.889\n', '848.109\n', '849.025\n', '848.72\n', '850.398\n', '850.093\n', '852.382\n', '850.856\n', '852.84\n', '852.84\n', '855.281\n', '854.671\n', '854.823\n', '853.755\n', '854.976\n', '855.434\n', '857.265\n', '856.502\n', '858.638\n', '858.791\n', '854.518\n', '855.739\n', '857.875\n', '855.281\n', '853.45\n', '854.061\n', '856.502\n', '856.807\n', '857.265\n', '856.044\n', '855.434\n', '857.418\n', '856.655\n', '856.349\n', '856.502\n', '858.333\n', '852.84\n', '856.96\n', '858.028\n', '857.418\n', '857.265\n', '856.655\n', '857.265\n', '855.586\n', '855.129\n', '855.434\n', '857.875\n', '855.892\n', '853.755\n', '855.129\n', '854.518\n', '855.586\n', '856.807\n', '853.603\n', '854.061\n', '853.298\n', '856.197\n', '855.739\n', '856.807\n', '856.197\n', '854.366\n', '855.281\n', '852.687\n', '855.129\n', '853.145\n', '849.941\n', '852.992\n', '850.551\n', '853.298\n', '848.872\n', '849.025\n', '852.534\n', '851.161\n', '849.483\n', '847.804\n', '849.635\n', '846.736\n', '845.058\n', '846.126\n', '845.973\n', '845.363\n', '842.769\n', '845.82\n', '841.09\n', '843.074\n', '841.548\n', '842.921\n', '842.006\n', '838.343\n', '837.275\n', '836.512\n', '836.97\n', '836.512\n', '835.139\n', '836.512\n', '835.444\n', '833.766\n', '833.155\n', '834.223\n', '830.714\n', '831.324\n', '831.629\n', '833.766\n', '829.035\n', '828.73\n', '826.746\n', '824.305\n', '827.815\n', '826.899\n', '825.221\n', '822.474\n', '824\n', '822.321\n', '821.406\n', '817.286\n', '816.523\n', '816.523\n', '812.861\n', '814.234\n', '811.945\n', '808.435\n', '810.877\n', '805.994\n', '798.212\n', '800.958\n', '804.773\n', '799.28\n', '802.026\n', '798.364\n', '795.465\n', '793.024\n', '793.786\n', '793.634\n', '794.549\n', '792.26\n', '791.955\n', '786.157\n', '785.241\n', '787.072\n', '785.699\n', '782.647\n', '778.222\n', '780.053\n', '774.865\n', '774.255\n', '773.949\n', '770.745\n', '769.067\n', '770.287\n', '769.372\n', '764.489\n', '760.216\n', '752.281\n', '745.109\n', '734.886\n', '724.967\n', '722.526\n', '701.468\n', '702.689\n', '691.855\n', '684.683\n', '671.865\n', '658.437\n', '641.346\n', '634.632\n', '617.542\n', '607.013\n', '591.907\n', '582.904\n', '569.933\n', '563.372\n', '556.963\n', '547.044\n', '525.224\n', '521.714\n', '512.864\n', '505.234\n', '495.773\n', '481.887\n', '472.884\n', '457.778\n', '448.012\n', '432.905\n', '421.308\n', '415.357\n', '401.471\n', '394.299\n', '382.702\n', '369.121\n', '342.723\n', '346.843\n', '340.129\n', '332.347\n', '325.175\n', '313.73\n', '306.864\n', '295.877\n', '292.825\n', '281.686\n', '277.261\n', '263.985\n', '248.878\n', '245.521\n', '239.265\n', '237.281\n', '227.821\n', '222.48\n', '216.071\n', '206.61\n', '202.032\n', '193.64\n', '173.04\n', '167.852\n', '168.767\n', '164.8\n', '159.917\n', '154.424\n', '152.287\n', '147.252\n', '141.606\n', '136.265\n', '132.145\n', '129.551\n', '121.159\n', '116.276\n', '113.529\n', '108.341\n', '99.338\n', '88.046\n', '81.332\n', '72.787\n', '71.108\n', '68.361\n', '60.579\n', '56.917\n', '44.404\n', '42.726\n', '28.382\n', '27.161\n', '16.633\n', '12.818\n', '5.646\n', '1.984\n', '3.052\n', '-139.317\n', '-44.099\n', '-57.07\n', '-20.447\n', '-26.399\n', '-22.736\n', '-25.33\n', '-29.145\n', '-27.009\n', '-25.636\n', '-27.467\n', '-26.093\n', '-30.061\n', '-30.671\n', '-29.756\n', '-29.145\n', '-29.45\n', '-31.281\n', '-28.993\n', '-28.687\n', '-28.687\n', '-30.519\n', '-30.976\n', '-29.603\n', '-28.687\n', '-32.655\n', '-29.45\n', '-27.619\n', '-28.84\n', '-30.824\n', '-27.467\n', '-29.45\n', '-29.298\n', '-32.96\n', '-31.434\n', '-32.35\n', '-31.129\n', '-32.655\n', '-30.519\n', '-33.113\n', '-32.96\n', '-31.587\n', '-30.366\n', '-32.502\n', '-31.434\n', '-31.739\n', '-29.908\n', '-30.976\n', '-33.57\n', '-33.723\n', '-29.603\n', '-32.197\n', '-31.892\n', '-27.772\n', '-31.281\n', '-29.45\n', '-29.908\n', '-32.044\n', '-31.892\n', '-32.502\n', '-33.113\n', '-31.587\n', '-32.807\n', '-32.502\n', '-31.587\n', '-31.739\n', '-31.739\n', '-30.671\n', '-30.824\n', '-32.35\n', '-31.739\n', '-32.197\n', '-31.587\n', '-32.197\n', '-30.213\n', '-32.044\n', '-29.908\n', '-34.333\n', '-32.35\n', '-31.892\n', '-33.57\n', '-35.554\n', '-32.807\n', '-29.145\n', '-31.281\n', '-35.249\n', '-35.096\n', '-30.671\n', '-32.96\n', '-28.993\n', '-30.671\n', '-30.671\n', '-32.655\n', '-30.366\n', '-33.265\n', '-33.876\n', '-35.401\n', '-33.418\n', '-32.502\n', '-33.876\n', '-35.096\n', '-31.892\n', '-31.892\n', '-32.35\n', '-29.908\n', '-33.113\n', '-32.197\n', '-32.655\n', '-33.876\n', '-31.434\n', '-31.739\n', '-33.113\n', '-29.298\n', '-30.519\n', '-31.892\n', '-32.96\n', '-35.096\n', '-34.486\n', '-31.587\n', '-33.113\n', '-31.892\n', '-34.333\n', '-31.892\n', '-31.587\n', '-30.824\n', '-31.281\n', '-30.213\n', '-32.197\n', '-32.044\n', '-30.366\n', '-28.077\n', '-29.603\n', '-28.23\n', '-27.619\n', '-31.129\n', '-30.366\n', '-32.044\n', '-31.281\n', '-31.587\n', '-31.892\n', '-35.554\n', '-29.45\n', '-34.486\n', '-32.35\n', '-32.96\n', '-32.807\n', '-31.587\n', '-31.281\n', '-32.044\n', '-27.772\n', '-31.739\n', '-31.739\n', '-32.044\n', '-28.687\n', '-31.281\n', '-28.84\n', '-28.993\n', '-31.892\n', '-33.265\n', '-33.265\n', '-30.366\n', '-31.892\n', '-29.603\n', '-31.281\n', '-29.756\n', '-30.671\n', '-29.756\n', '-29.603\n', '-33.113\n', '-33.876\n', '-30.976\n', '-30.519\n', '-32.044\n', '-32.655\n', '-30.671\n', '-32.96\n', '-31.129\n']
i = np.asarray(i)
i = i.astype(float)
plt.plot(i)
# current before filter


def savitzky_golay(y, window_size, order, deriv, rate=1):
   
    try:
        window_size = np.abs(int(window_size))
        order = np.abs(int(order))
    except ValueError:
        raise ValueError("window_size and order have to be of type int")
    if window_size % 2 != 1 or window_size < 1:
        raise TypeError("window_size size must be a positive odd number")
    if window_size < order + 2:
        raise TypeError("window_size is too small for the polynomials order")
    order_range = range(order+1)
    half_window = (window_size -1) // 2
    # precompute coefficients
    # Jacobian 
    b = np.mat([[k**i for i in order_range] for k in range(-half_window, half_window+1)])
    b = b.astype(float)
    
    # add parabol coeff  
    para = []
    for i in range( half_window*-1 , half_window+1 ):
        # print(i)
        para.append( 1 - (i / (half_window +1) )**2) 
   
    w_b = np.copy(b)
    for i in range( len(b)) : 
        w_b[i] = w_b[i]*para[i]

        
    # Equation Solution pseudo inv
    # .A is Matrix to array
    m = np.linalg.pinv(b).A[deriv] * rate**deriv * factorial(deriv)
    # Normal inv 
    M = np.matmul( np.linalg.inv(   np.matmul(np.transpose(b),b)),  np.transpose(b)  )
    M = M[deriv] * rate**deriv * factorial(deriv) 
    M= np.asarray(M)
    M= M.flatten()
    # Normal inv parabol coeff
    m1 = np.matmul( np.linalg.inv(   np.matmul(np.transpose(b),w_b)),  np.transpose(w_b)  )
    m1 = m1[deriv] * rate**deriv * factorial(deriv) 
    m1= np.asarray(M)
    m1= m1.flatten()

    
   # pad the signal at the extremes with
   # values taken from the signal itself
   # firstvals = y[0] - np.abs( y[1:half_window+1][::-1] - y[0] )
   # lastvals = y[-1] + np.abs(y[-half_window-1:-1][::-1] - y[-1])
   # y = np.concatenate((firstvals, y, lastvals))
    return np.convolve( m[::-1], y, mode='valid')  , np.convolve( M[::-1], y, mode='valid') ,  np.convolve( m1[::-1], y, mode='valid') 

# two windows 41 before and after
res1, res2 ,res3 = savitzky_golay(i, window_size=83, order=3,deriv=0)

plt.plot(res1)
#pseudo inverse Moore penrose rect smoothing


res4 = savgol_filter(i, 83, 3, deriv = 3 )
plt.plot(res4)

